Option Explicit

Sub AjusterTaillePolice()
    Dim ws As Worksheet
    Dim cell As Range
    Dim mergedCell As Range
    Dim plageTableau As Range
    Dim largeurCell As Double
    Dim hauteurCell As Double
    Dim cellValue As String
    Dim ctlLabel As Object

    ' Feuille active
    Set ws = ActiveSheet

    ' Plage du tableau
    Set plageTableau = ws.Range("A1:AA43")

    ' Objet pour mesurer le texte
    Set ctlLabel = CreateObject("Forms.Label.1")
    ctlLabel.Font.Name = ws.Cells(1, 1).Font.Name
    ctlLabel.Visible = False ' pas besoin d'afficher

    Application.ScreenUpdating = False

    For Each cell In plageTableau
        On Error Resume Next

        ' Ignorer les lignes paires
        If cell.Row Mod 2 = 0 Then GoTo NextCell

        If cell.MergeCells Then
            Set mergedCell = cell.MergeArea
            If cell.Address = mergedCell.Cells(1, 1).Address Then
                largeurCell = mergedCell.Width
                hauteurCell = mergedCell.Height
                cellValue = CStr(mergedCell.Value)
                Call AjusterTailleAvecMesure(mergedCell, largeurCell, hauteurCell, cellValue, ctlLabel)
            End If
        Else
            If ACelluleAvecBordures(cell) Then
                largeurCell = cell.Width
                hauteurCell = cell.Height
                cellValue = CStr(cell.Value)
                Call AjusterTailleAvecMesure(cell, largeurCell, hauteurCell, cellValue, ctlLabel)
            End If
        End If

NextCell:
        On Error GoTo 0
    Next cell

    Application.ScreenUpdating = True
    MsgBox "Ajustement de la taille des polices terminé!", vbInformation
End Sub

Sub AjusterTailleAvecMesure(cellRange As Range, largeur As Double, hauteur As Double, texte As String, ctlLabel As Object)
    Dim tailleMin As Double: tailleMin = 6
    Dim tailleMax As Double: tailleMax = 18
    Dim tailleTest As Double
    Dim ok As Boolean: ok = False

    For tailleTest = tailleMax To tailleMin Step -0.5
        With ctlLabel
            .AutoSize = False
            .WordWrap = True
            .Width = largeur
            .Caption = texte
            .Font.Size = tailleTest
        End With

        DoEvents

        ' Remettre autosize pour mesurer la hauteur réelle
        ctlLabel.AutoSize = True

        If ctlLabel.Height <= hauteur And ctlLabel.Width <= largeur Then
            ok = True
            Exit For
        End If
    Next tailleTest

    If Not ok Then tailleTest = tailleMin

    With cellRange
        .Font.Size = tailleTest
        .WrapText = True
        .ShrinkToFit = False
        .Font.Bold = True
    End With
End Sub

Function ACelluleAvecBordures(cell As Range) As Boolean
    On Error Resume Next
    ACelluleAvecBordures = (cell.Borders(xlEdgeLeft).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeRight).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeTop).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeBottom).LineStyle <> xlNone)
    On Error GoTo 0
End Function

Sub AjusterTailleTableauComplet()
    Call AjusterTaillePolice
End Sub
