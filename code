Option Explicit

Sub AjusterTaillePolice()
    Dim ws As Worksheet
    Dim cell As Range
    Dim mergedCell As Range
    Dim plageTableau As Range
    Dim largeurCell As Double
    Dim hauteurCell As Double
    Dim texte As String
    Dim tailleCalculée As Double

    Set ws = ActiveSheet
    Set plageTableau = ws.Range("A1:AA1500") ' ✅ élargi jusqu’à ligne 1500

    Application.ScreenUpdating = False

    For Each cell In plageTableau
        On Error Resume Next

        ' Ignorer les lignes paires (libellés de voie)
        If cell.Row Mod 2 = 0 Then GoTo NextCell

        ' Cellule fusionnée
        If cell.MergeCells Then
            Set mergedCell = cell.MergeArea
            If cell.Address = mergedCell.Cells(1, 1).Address Then
                largeurCell = mergedCell.Width
                hauteurCell = mergedCell.Height
                texte = CStr(mergedCell.Value)
                tailleCalculée = CalculerTaillePolice(largeurCell, hauteurCell, texte)
                AppliquerFormat mergedCell, tailleCalculée
            End If
        Else
            ' Cellule non fusionnée avec bordures
            If ACelluleAvecBordures(cell) Then
                If Not IsEmpty(cell.Value) Then
                    largeurCell = cell.Width
                    hauteurCell = cell.Height
                    texte = CStr(cell.Value)
                    tailleCalculée = CalculerTaillePolice(largeurCell, hauteurCell, texte)
                    AppliquerFormat cell, tailleCalculée
                End If
            End If
        End If

NextCell:
        On Error GoTo 0
    Next cell

    Application.ScreenUpdating = True
    MsgBox "Ajustement terminé sur A1:AA1500 ✔️", vbInformation
End Sub

Function CalculerTaillePolice(largeur As Double, hauteur As Double, texte As String) As Double
    Dim tailleMin As Double: tailleMin = 6
    Dim tailleMax As Double: tailleMax = 18
    Dim longueur As Long
    Dim tailleParLargeur As Double
    Dim tailleParHauteur As Double
    Dim facteurLargeur As Double: facteurLargeur = 1.2 ' ajustable selon ton besoin

    longueur = Len(texte)
    If longueur = 0 Then
        CalculerTaillePolice = tailleMin
        Exit Function
    End If

    ' Estimations en fonction des dimensions disponibles
    tailleParLargeur = largeur / (longueur * facteurLargeur)
    tailleParHauteur = hauteur / 1.2 ' empirique : hauteur ligne ~1.2 × taille

    ' Prendre la plus petite des deux
    CalculerTaillePolice = Application.WorksheetFunction.Min(tailleParLargeur, tailleParHauteur)

    ' Clamp dans [6, 18]
    If CalculerTaillePolice < tailleMin Then CalculerTaillePolice = tailleMin
    If CalculerTaillePolice > tailleMax Then CalculerTaillePolice = tailleMax

    ' Arrondir à 0.5 près
    CalculerTaillePolice = Round(CalculerTaillePolice * 2) / 2
End Function

Sub AppliquerFormat(c As Range, taille As Double)
    With c
        .Font.Size = taille
        .Font.Bold = True
        .WrapText = True
        .ShrinkToFit = False
    End With
End Sub

Function ACelluleAvecBordures(cell As Range) As Boolean
    On Error Resume Next
    ACelluleAvecBordures = (cell.Borders(xlEdgeLeft).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeRight).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeTop).LineStyle <> xlNone) And _
                           (cell.Borders(xlEdgeBottom).LineStyle <> xlNone)
    On Error GoTo 0
End Function

Sub AjusterTailleTableauComplet()
    Call AjusterTaillePolice
End Sub
